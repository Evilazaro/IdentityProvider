# ------------------------------------------------------------------------------
# SCHEMA DEFINITION
# ------------------------------------------------------------------------------
# Defines the schema version for DevCenter image definition validation
$schema: "1.0"

# ------------------------------------------------------------------------------
# BASIC IMAGE INFORMATION
# ------------------------------------------------------------------------------
# Unique identifier for this image definition - should be descriptive and follow naming conventions
name: identityProvider-backend-engineer

# Detailed description explaining the purpose of this image
description: "This image definition sets up a development environment for backend engineers."

# ------------------------------------------------------------------------------
# BASE IMAGE CONFIGURATION
# ------------------------------------------------------------------------------
# Microsoft-provided base image with Visual Studio 2022 Enterprise
# Includes Windows 11 and Microsoft 365 apps pre-installed
# Reference: https://learn.microsoft.com/en-us/azure/dev-box/tutorial-dev-box-service
image: microsoftvisualstudio_visualstudioplustools_vs-2022-ent-general-win11-m365-gen2

# ------------------------------------------------------------------------------
# AUTOMATED SETUP TASKS
# ------------------------------------------------------------------------------
# These tasks run automatically during image creation with admin privileges
tasks:
  # ------------------------------------------------------------------------------
  # TASK 1: PowerShell Environment Setup
  # ------------------------------------------------------------------------------
  - name: ~/powershell # Built-in PowerShell task provider
    description: "Configure PowerShell environment and install DSC resources"
    parameters:
      command: |
        # Allow script execution with sufficient privileges for setup
        Set-ExecutionPolicy -ExecutionPolicy Bypass -Force -Scope Process

        # Install package provider needed for module management
        # Forces installation without prompts and applies to all users
        Install-PackageProvider -Name NuGet -Force -Scope AllUsers

        # Trust the PowerShell Gallery to enable automated module installation
        Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted

        # Install PowerShell Desired State Configuration resources
        # Required for declarative configuration management
        # AllowClobber permits overwriting any existing versions
        Install-Module -Name PSDSCResources -Force -AllowClobber -Scope AllUsers

  # ------------------------------------------------------------------------------
  # TASK 2: Common Engineering Tools Installation
  # ------------------------------------------------------------------------------
  - name: ~/winget # Uses WinGet task provider for package installation
    description: "Import common engineering tools and configurations"
    parameters:
      # External DSC configuration hosted on GitHub
      # Contains definitions for tools used across all engineering roles
      downloadUrl: "https://raw.githubusercontent.com/Evilazaro/DevExp-DevBox/refs/heads/main/.configuration/devcenter/workloads/common-config.dsc.yaml"

      # Local file path where the configuration will be saved
      # Stored in a dedicated directory for WinGet configurations
      configurationFile: "c:\\winget\\common-config.dsc.yaml"

  # ------------------------------------------------------------------------------
  # TASK 3: Backend-specific Development Tools
  # ------------------------------------------------------------------------------
  - name: ~/winget
    description: "Import common engineering tools and configurations"
    parameters:
      # Backend-specific tools configuration (likely includes database tools,
      # API development tools, server frameworks, etc.)
      downloadUrl: "https://raw.githubusercontent.com/Evilazaro/DevExp-DevBox/refs/heads/main/.configuration/devcenter/workloads/common-backend-config.dsc.yaml"

      # Local storage path for configuration reference
      configurationFile: "c:\\winget\\common-backend-config.dsc.yaml"

# ------------------------------------------------------------------------------
# USER-INITIATED OPTIONAL TASKS
# ------------------------------------------------------------------------------
# Tasks that are not run automatically but can be executed by users post-setup
# Useful for personalization and role-specific tooling that isn't required for all users
userTasks:
  # ------------------------------------------------------------------------------
  # OPTIONAL TASK: Backend User Tools
  # ------------------------------------------------------------------------------
  - name: ~/winget
    description: "Import common engineering tools and configurations"
    parameters:
      # Contains optional tools that backend engineers might need based on specific projects
      # Not installed by default to keep base image lean
      downloadUrl: "https://raw.githubusercontent.com/Evilazaro/DevExp-DevBox/refs/heads/main/.configuration/devcenter/workloads/common-backend-usertasks-config.dsc.yaml"

      # Local path for configuration storage
      # Follows same convention as other WinGet configurations
      configurationFile: "c:\\winget\\common-backend-usertasks-config.dsc.yaml"
